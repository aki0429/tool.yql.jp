<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Multi Viewer - tool.ikunocam.net</title>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<style>
html, body {
  margin: 0; padding: 0; height: 100%;
  background: #000; color: #ccc;
  font-family: sans-serif; overflow: hidden;
}

/* ===== 選択画面レイアウト (Flexbox) ===== */
#select {
  display: flex;
  flex-direction: column;
  height: 100vh;
}

/* リスト部分のみスクロール */
.scroll-content {
  flex: 1;
  overflow-y: auto;
  padding: 15px;
  padding-bottom: 20px;
}

.input-area {
  background: #111; padding: 15px; border-radius: 8px;
  display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px;
  border: 1px solid #333;
}

.input-area input {
  background: #222; border: 1px solid #444; color: #fff;
  padding: 8px; border-radius: 4px;
}

#list {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 10px;
}

.item {
  background: #1a1a1a; padding: 10px; border-radius: 4px; border: 1px solid #333;
}

.item label { display: flex; align-items: center; cursor: pointer; gap: 10px; }

/* ===== 下部固定ボタン ===== */
.buttons {
  flex-shrink: 0;
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  background: #111;
  border-top: 2px solid #333;
  padding: 5px;
}

.buttons button {
  background: #222; color: #fff; border: 1px solid #444;
  padding: 15px 5px; cursor: pointer; font-weight: bold;
}

.buttons button:hover { background: #444; }

/* ===== 表示画面レイアウト ===== */
#view { height: 100%; display: none; overflow: hidden; }
#grid { height: 100%; margin: 2px; display: grid; gap: 2px; }

.cell {
  border: 1px solid #333; position: relative;
  background: #000; aspect-ratio: 16/9; overflow: hidden;
}

.cell video, .cell img, .cell iframe {
  width: 100%; height: 100%; object-fit: contain; border: 0;
}

/* 6分割メイン設定 */
.cell.main { grid-column: 1 / 3; grid-row: 1 / 3; }

.label {
  position: absolute; left: 0; right: 0; bottom: 0;
  font-size: 11px; background: rgba(0,0,0,0.6); padding: 2px 6px;
  pointer-events: none; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}

.error {
  position: absolute; inset: 0; display: none; align-items: center;
  justify-content: center; text-align: center; font-size: 12px;
  color: #ff5555; background: rgba(0,0,0,0.8); z-index: 5;
}

#fsBtn {
  position: fixed; right: 10px; top: 10px; z-index: 999;
  background: rgba(0,0,0,0.5); color: #fff; border: 1px solid #555;
  padding: 6px 12px; display: none; cursor: pointer; border-radius: 4px;
}
</style>
</head>

<body>

<div id="select">
  <div class="scroll-content">
    <div class="input-area">
      <input id="ytName" placeholder="表示名称" style="flex:1;">
      <input id="ytUrl" placeholder="YouTube URL / 配信URL" style="flex:2;">
      <button onclick="addNewStream()">保存して追加</button>
      <button id="selectAllBtn">全選択</button>
    </div>
    <div id="list"></div>
  </div>

  <div class="buttons">
    <button onclick="start(4)">4</button>
    <button onclick="start(6)">6</button>
    <button onclick="start(9)">9</button>
    <button onclick="start(16)">16</button>
    <button onclick="start(32)">32</button>
    <button onclick="start(64)">64</button>
    <button onclick="start(100)">100</button>
  </div>
</div>

<div id="view">
  <div id="grid"></div>
</div>
<button id="fsBtn">全画面切替</button>

<script>
const JSON_URL = 'streams.json';
const LS_KEY   = 'yt_streams';
let streams = [];
let activeTimers = [];

// YouTube ID抽出
function getYTId(url) {
  if(!url) return null;
  const m = url.match(/(?:v=|youtu\.be\/|embed\/|live\/)([a-zA-Z0-9_-]+)/);
  return m ? m[1] : (url.length === 11 ? url : null);
}

// YouTube埋め込みURL (vq=mediumで360p付近をターゲット)
function createEmbedUrl(id) {
  return `https://www.youtube.com/embed/${id}?autoplay=1&mute=1&playsinline=1&rel=0&vq=medium`;
}

const loadLocal = () => JSON.parse(localStorage.getItem(LS_KEY)||'[]');
const saveLocal = v => localStorage.setItem(LS_KEY, JSON.stringify(v));

// データの初期読み込み
fetch(JSON_URL).then(r=>r.json()).catch(()=>[]).then(j=>{
  const processedJson = (j || []).map(s => {
    if(s.type === 'youtube' && !s.embed) s.embed = createEmbedUrl(getYTId(s.url));
    return s;
  });
  streams = processedJson.concat(loadLocal());
  renderList();
});

function renderList(){
  const list = document.getElementById('list');
  list.innerHTML='';
  streams.forEach(s=>{
    const d=document.createElement('div');
    d.className='item';
    d.innerHTML=`<label><input type="checkbox" value="${s.id}"> <span>${s.name}</span> <small style="color:#666">(${s.type})</small></label>`;
    list.appendChild(d);
  });
}

function addNewStream() {
  const name = document.getElementById('ytName').value || 'New Stream';
  const url = document.getElementById('ytUrl').value;
  if(!url) return;

  let item = { id: 'st_'+Date.now(), name: name, url: url };
  const ytId = getYTId(url);

  if(ytId) {
    item.type = 'youtube';
    item.embed = createEmbedUrl(ytId);
  } else {
    item.type = url.includes('.m3u8') ? 'hls' : (url.includes('.cgi') ? 'cgi' : 'video');
  }

  const local = loadLocal(); local.push(item); saveLocal(local);
  streams.push(item); renderList();
  document.getElementById('ytUrl').value = '';
}

document.getElementById('selectAllBtn').onclick=()=>{
  const c=document.querySelectorAll('#list input');
  const all=[...c].every(x=>x.checked);
  c.forEach(x=>x.checked=!all);
};

document.getElementById('fsBtn').onclick=()=>{
  document.fullscreenElement ? document.exitFullscreen() : document.documentElement.requestFullscreen();
};

function start(split){
  const ids=[...document.querySelectorAll('#list input:checked')].map(i=>i.value);
  if(ids.length === 0) return alert('配信を選択してください');

  document.getElementById('select').style.display='none';
  document.getElementById('view').style.display='block';
  document.getElementById('fsBtn').style.display='block';

  // 既存のCGIタイマーを解除
  activeTimers.forEach(t => clearInterval(t));
  activeTimers = [];

  const grid = document.getElementById('grid');
  let cols, rows, isL6 = false;
  if(split===6){ cols=3; rows=3; isL6=true; }
  else { cols=Math.ceil(Math.sqrt(split)); rows=Math.ceil(split/cols); }

  grid.style.gridTemplateColumns=`repeat(${cols},1fr)`;
  grid.style.gridTemplateRows=`repeat(${rows},1fr)`;
  grid.innerHTML='';

  // ループの回数をsplitに合わせて調整
  for(let i=0; i<(isL6 ? 6 : split); i++){
    const s=streams.find(x=>x.id===ids[i]);
    const cell = document.createElement('div');
    cell.className = 'cell';
    if(isL6 && i===0) cell.classList.add('main');

    const label = document.createElement('div'); label.className = 'label';
    const error = document.createElement('div'); error.className = 'error';

    if(!s){
      const img=document.createElement('img');
      img.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=';
      cell.appendChild(img);
      error.textContent = 'NO SOURCE'; error.style.display = 'flex';
    } else if(s.type==='youtube'){
      const f=document.createElement('iframe');
      f.src=s.embed;
      f.allow='autoplay; encrypted-media; picture-in-picture';
      cell.appendChild(f);
      label.textContent = s.name;
    } else if(s.type==='cgi'){
      const img = document.createElement('img');
      const update = () => { img.src = `proxy.php?url=${encodeURIComponent(s.url)}&_t=${Date.now()}`; };
      update();
      activeTimers.push(setInterval(update, 1000));
      cell.appendChild(img);
      label.textContent = s.name;
    } else {
      const v = document.createElement('video');
      v.muted = true; v.autoplay = true; v.playsInline = true;
      const vSrc = `proxy.php?url=${encodeURIComponent(s.url)}`;

      if (s.url.includes('.m3u8')) {
        if (Hls.isSupported()) {
          const hls = new Hls({
            xhrSetup: function(xhr, url) { xhr.withCredentials = false; }
          });
          hls.loadSource(vSrc);
          hls.attachMedia(v);
        } else if (v.canPlayType('application/vnd.apple.mpegurl')) {
          v.src = vSrc;
        }
      } else {
        v.src = vSrc;
      }
      v.onerror = () => { error.textContent = 'VIDEO ERROR'; error.style.display = 'flex'; };
      v.onplaying = () => { error.style.display = 'none'; };
      cell.appendChild(v);
      label.textContent = s.name;
    }

    // 重要：これらをcellに追加し、最後にcellをgridに追加する
    cell.appendChild(error);
    cell.appendChild(label);
    grid.appendChild(cell);
  }
}
</script>
</body>
</html>