<!DOCTYPE html>
<html>
    <head>
        <title>河川カメラ for MiyakoCam・アッキー</title>
        <meta charset="UTF-8" lang="ja">
        <meta name="viewport" content="width=device-width,initial-scale=1">
        <meta name="description" content="河川カメラ for MiyakoCam・アッキー">
        <meta property="twitter:card" content="summary">
        <meta property="twitter:site" content="@MiyakoCam">
        <meta property="twitter:description" content="河川カメラ for MiyakoCam・アッキー">
        <meta property="og:title" content="河川カメラ for MiyakoCam・アッキー">
        <meta property="og:image" content="og.png">
        <meta property="og:site_name" content="河川カメラ for MiyakoCam・アッキー">
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css" integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ==" crossorigin="" />
        <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
        <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js" integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ==" crossorigin=""></script>
        
        <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
        <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
        <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

        <script src="leaflet_url.js"></script>
        <script src="https://unpkg.com/leaflet.vectorgrid@latest/dist/Leaflet.VectorGrid.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/leaflet-rotatedmarker"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
        <script src="https://unpkg.com/@popperjs/core@2"></script>
        <script src="https://unpkg.com/tippy.js@6.3.7/dist/tippy-bundle.umd.min.js"></script>
        <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
        
        <style>
            body {
                font-family: 'Noto Sans JP', -apple-system, BlinkMacSystemFont, sans-serif;
            }

            .button, .mode_btn, .setsumei {
                font-family: 'Noto Sans JP', -apple-system, BlinkMacSystemFont, sans-serif;
                background: #000000aa;
                border: white 2.5px solid;
                border-radius: 5px;
                color: white;
                padding: 5px;
                font-weight: 500;
                font-size: 0.9rem;
                cursor: pointer;
                z-index: 10000;
                user-select: none;
            }

            #photoModal {
                z-index: 10000000;
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                display: none;
                color: white;
            }
            #photoModal.display {
                display: block;
            }
            #photoModal_back {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: #000000bb;
                backdrop-filter: blur(5px);
            }
            #photoModal_photo {
                z-index: 10000002;
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
            }
            #photoModal_photo_name {
                font-size: 1.4rem;
                text-align: center;
                margin-bottom: 0.5rem;
            }
            #photoModal_photo_img {
                height: calc(80vh - 2rem);
            }
            #close_photoModal, .modal_close {
                z-index: 10000003;
                position: absolute;
                font-size: 1.3rem;
                color: white;
                top: 0px;
                right: 0px;
                cursor: pointer;
                padding: 5px;
            }
            #slideshow_select_label {
                z-index: 10000002;
                position: absolute;
                bottom: 3px;
                right: 5px;
                color: white;
            }
            .modal {
                z-index: 100000;
                width: 100%;
                height: 100%;
                position: absolute;
                top: 0;
                left: 0;
                display: none;
            }
            .modal.display {
                display: block;
            }
            #back_div_prefselect, .modal_back {
                width: 100%;
                height: 100%;
                background-color: #00000099;
                position: absolute;
                top: 0;
                left: 0;
                backdrop-filter: blur(5px);
                z-index: 100001;
            }
            #front_div_prefselect, .modal_front {
                z-index: 100002;
                color: white;
                width: 80%;
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%,-50%);
                text-align: center;
            }
            #front_div_prefselect input[type=checkbox], .modal_front input[type=checkbox] {
                margin-left: 2em;
            }
            #front_div_prefselect div, .modal_front div {
                margin: 1rem 0;
            }
            #cancel_front_div_prefselect {
                display: inline-block;
                background: #ff000099;
                border: white 2px solid;
                border-radius: 5px;
                padding: 5px;
                cursor: pointer;
            }
            #ok_front_div_prefselect {
                display: inline-block;
                background: #0062ff99;
                border: white 2px solid;
                border-radius: 5px;
                padding: 5px;
                margin-left: 1rem;
                cursor: pointer;
            }
        </style>
    </head>
    <body>
        <div id="map" style="background: white"></div>

        <div class="btns">
            <button id="slideshow_start_btn" class="button">ｽﾗｲﾄﾞｼｮｰ開始</button>
            <button id="slideshow_edit_btn" class="button">ｽﾗｲﾄﾞｼｮｰ編集</button>
        </div>

        <div id="div_slideshow_edit" class="modal">
            <span id="close_div_slideshow_edit" class="modal_close">×</span>
            <div class="modal_back"></div>
            <div id="front_div_slideshow_edit" class="modal_front">
                <div><span style="font-size: 1.4rem;">スライドショー編集</span></div>
            </div>
        </div>
        
        <div id="photoModal">
            <span id="close_photoModal">×</span>
            <div id="photoModal_back"></div>
            <div id="photoModal_photo">
                <div id="photoModal_photo_name">カメラ観測点名</div>
                <img src="https://placehold.jp/640x480.png" id="photoModal_photo_img">
            </div>
            <label id="slideshow_select_label"><input type="checkbox" id="slideshow_select_checkbox" onchange="slideshow_checkbox(this)" data-camid="00000000" data-camname="カメラ観測点名">ｽﾗｲﾄﾞｼｮｰ保存</label>
        </div>
    </body>

    <link rel="stylesheet" href="amedas.css">
    <script>
// 変数のグローバルスコープ定義
let map;
let markers;
let updateTimer = null;
let pointLatLngList = {};
let slideshowList = localStorage.getItem('slideshowList') ? 
    JSON.parse(localStorage.getItem('slideshowList')) : {};

// 定数定義を追加
const BASE_URL = location.hostname === 'localhost' || location.hostname === '127.0.0.1' 
    ? '' 
    : 'https://tool.yql.jp/rivercam';

// 地図初期化関数
function initMap() {
    if (map) return; 

    map = L.map('map', {
        zoomSnap: 0,
        center: [37.575, 137.984],
        zoom: 5.6,
        minZoom: 4,
        preferCanvas: false,
    });

    if (typeof L.urlHandler === 'function') {
        let url = L.urlHandler(map);
        if (url && typeof url._zoom !== 'undefined') {
            map.setView([url._lat, url._lng], url._zoom);
        }
    }

    map.zoomControl.setPosition('topright');
    map.attributionControl.addAttribution("国土交通省");
    map.attributionControl.addAttribution("L.urlHandler");

    map.createPane("pane_map").style.zIndex = 1;

    var baseMap = {
        "Google 標準地図": L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {pane: "pane_map",}).addTo(map),
    };

    L.control.layers(baseMap).addTo(map);
    
    markers = L.markerClusterGroup({
        showCoverageOnHover: false,
        zoomToBoundsOnClick: true,
        disableClusteringAtZoom: 13, 
        maxClusterRadius: function(zoom) {
            if (zoom <= 6) {         // 日本全体レベル
                return 120;
            } else if (zoom <= 8) {  // 地方レベル
                return 90;
            } else if (zoom <= 10) { // 都道府県レベル
                return 60;
            } else {                 // 市町村レベル
                return 30;
            }
        }
    }).addTo(map);

    map.on('moveend', function() {
        if (updateTimer) clearTimeout(updateTimer);
    });

    loadAllCameraData();
}

document.addEventListener('DOMContentLoaded', function() {
    try {
        initMap();
    } catch (error) {
        console.error('地図の初期化に失敗しました:', error);
    }
}, { once: true });

window.addEventListener('error', function(e) {
    return true;
}, true);

class CameraCache {
    constructor() {
        this.store = localStorage;
        this.prefix = 'riverCam_json_';
        this.version = 1;
        this.expiration = 28 * 24 * 60 * 60 * 1000; // 4週間
    }
    _key(id) { return `${this.prefix}${id}`; }
    _isValid(data) {
        return data && data.version === this.version && (new Date().getTime() - data.timestamp) < this.expiration;
    }
    set(id, value) {
        const data = { version: this.version, timestamp: new Date().getTime(), value: value };
        this.store.setItem(this._key(id), JSON.stringify(data));
    }
    get(id) {
        try {
            const data = JSON.parse(this.store.getItem(this._key(id)));
            if (this._isValid(data)) return data.value;
            this.remove(id);
        } catch (e) { this.remove(id); }
        return null;
    }
    remove(id) { this.store.removeItem(this._key(id)); }
}

const cameraCache = new CameraCache();

async function loadAllCameraData() {
    try {
        let allCameras = [];
        const listResponse = await fetch('json_files_list.json');
        if (!listResponse.ok) throw new Error('ファイルリストの取得に失敗しました');
        const fileList = await listResponse.json();
        
        for (const file of fileList.files) {
            const cachedData = cameraCache.get(file);
            if (cachedData) {
                allCameras.push(...cachedData);
                continue;
            }
            try {
                const filePath = file === 'json_files_list.json' ? file : 'cache/' + file;
                const response = await fetch(filePath);
                if (!response.ok) throw new Error(`HTTP ${response.status} ${file}`);
                const data = await response.json();
                
                if (data.features && Array.isArray(data.features)) {
                    const cameras = data.features
                        .filter(f => f.properties && f.properties.id && f.geometry && f.geometry.coordinates && f.geometry.coordinates.length === 2)
                        .map(f => ({
                            id: f.properties.id.toString(),
                            name: f.properties.name || '',
                            lat: f.geometry.coordinates[1],
                            lng: f.geometry.coordinates[0]
                        }));
                    if (cameras.length > 0) {
                        cameraCache.set(file, cameras);
                        allCameras.push(...cameras);
                    }
                }
            } catch (err) { console.warn(`ファイル ${file} の読み込みエラー:`, err); }
        }
        
        if (allCameras.length > 0) {
            console.log(`${allCameras.length}個のカメラデータを読み込みました`);
            drawMap(allCameras);
        } else { console.warn('有効なカメラデータが見つかりませんでした'); }
    } catch (error) { console.error('データ読み込みエラー:', error); }
}

function drawMap(cameras) {
    if (!markers) return;
    markers.clearLayers();

    const newMarkers = [];
    
    cameras.forEach(camera => {
        pointLatLngList[camera.id] = { name: camera.name, lat: camera.lat, lng: camera.lng };
        const latlon = new L.LatLng(camera.lat, camera.lng);
        const kariMarker = L.marker(latlon).bindTooltip(camera.name);
        
        kariMarker.on('click', async function() {
            try {
                document.getElementById('photoModal_photo_name').innerText = camera.name;
                document.getElementById('photoModal_photo_img').src = 'https://placehold.jp/640x480.png?text=Loading...';
                 document.getElementById('photoModal').classList.add('display');

                const response = await fetch(`proxy.php?cam_id=${camera.id}`);
                
                if (!response.ok) {
                    throw new Error(`カメラ情報の取得に失敗 (HTTP ${response.status})`);
                }
                const camInfo = await response.json();
                
                // ▼▼▼ 階層構造を考慮した画像URLの取得ロジックに修正 ▼▼▼
                let imageUrl = null;

                // 1. まず obsInfo の中の currProvUrl を探す (今回ご提示いただいた形式)
                if (camInfo.obsInfo && camInfo.obsInfo.currProvUrl) {
                    imageUrl = camInfo.obsInfo.currProvUrl;
                }
                // 2. 次に第一階層の currProvUrl を探す (別の形式のカメラ用)
                else if (camInfo.currProvUrl) {
                    imageUrl = camInfo.currProvUrl;
                }
                // 3. それでも無ければ archiveList の最新画像を代替として使用
                else if (camInfo.archiveList && camInfo.archiveList.length > 0 && camInfo.archiveList[0].arcUrl) {
                    console.log(`カメラID: ${camera.id} - currProvUrlが見つかりません。アーカイブ画像で代替します。`);
                    imageUrl = camInfo.archiveList[0].arcUrl;
                }

                // 表示できる画像URLが見つかった場合
                if (imageUrl) {
                    document.getElementById('photoModal_photo_img').src = imageUrl;
                } else {
                    // どのパターンにも一致しなかった場合
                    console.error(`画像URLを特定できませんでした。受信データ:`, camInfo);
                    throw new Error('現在利用可能な画像が見つかりません');
                }
                // ▲▲▲ 修正ここまで ▲▲▲

                document.getElementById('slideshow_select_label').innerHTML = 
                    `<input type="checkbox" id="slideshow_select_checkbox" onchange="slideshow_checkbox(this)" 
                       data-camid="${camera.id}" data-camname="${camera.name}" 
                       ${slideshowList[camera.id] ? "checked" : ""}>ｽﾗｲﾄﾞｼｮｰ保存`;

                initModalClose();

            } catch (error) {
                console.error(`カメラ画像(${camera.id})の読み込みに失敗しました:`, error);
                document.getElementById('photoModal_photo_img').src = 'https://placehold.jp/640x480.png?text=Error';
            }
        });
        
        newMarkers.push(kariMarker);
    });

    markers.addLayers(newMarkers);
}

function initModalClose() {
    const modal = document.getElementById('photoModal');
    const closeBtn = document.getElementById('close_photoModal');
    const modalBack = document.getElementById('photoModal_back');

    const closeModal = (e) => {
        e.preventDefault();
        e.stopPropagation();
        modal.classList.remove('display');
    };

    closeBtn.removeEventListener('click', closeModal);
    closeBtn.addEventListener('click', closeModal);
    modalBack.removeEventListener('click', closeModal);
    modalBack.addEventListener('click', closeModal);
}
    </script>
</html>