<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>外部GeoJSONファイル表示</title>
    <!-- Leaflet.js の CSS を読み込み -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
    <!-- Leaflet.js の JavaScript を読み込み -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>
    <style>
        /* ページ全体の余白をなくす */
        body {
            padding: 0;
            margin: 0;
            overflow: hidden; /* スクロールバーを非表示に */
            font-family: 'Helvetica Neue', Arial, sans-serif;
        }
        html, body, #map {
            height: 100%;
            width: 100vw;
        }
        /* 情報表示パネルのスタイル */
        #info-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 300px;
            max-height: calc(100% - 40px);
            background-color: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000; /* 地図より手前に表示 */
            overflow-y: auto;
            transition: transform 0.3s ease-in-out, visibility 0.3s;
            visibility: visible;
        }
        /* パネルが非表示の時のスタイル */
        #info-panel.hidden {
            transform: translateX(calc(100% + 30px)); /* 右側にスライドアウト */
            visibility: hidden;
        }
        #info-panel h2 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.3em;
            color: #333;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
        }
        #info-details {
            color: #555;
            line-height: 1.6;
        }
        #info-details strong {
            color: #111;
            margin-right: 5px;
        }
        #close-btn {
            position: absolute;
            top: 5px;
            right: 10px;
            background: none;
            border: none;
            font-size: 2em;
            line-height: 1;
            cursor: pointer;
            color: #888;
        }
        #close-btn:hover {
            color: #333;
        }
        /* --- ローディング画面のスタイル --- */
        #loader {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        .spinner {
            border: 8px solid #f3f3f3;
            border-radius: 50%;
            border-top: 8px solid #3498db;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        #loader p {
            margin-top: 20px;
            font-size: 1.2em;
            color: #333;
        }
        #progress-bar-container {
            width: 80%;
            max-width: 400px;
            background-color: #e0e0e0;
            border-radius: 5px;
            margin: 15px 0;
        }
        #progress-bar {
            width: 0%;
            height: 20px;
            background-color: #3498db;
            border-radius: 5px;
            transition: width 0.2s ease-out;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- ローディング画面 -->
    <div id="loader">
        <div class="spinner"></div>
        <p>データを読み込み中...</p>
        <div id="progress-bar-container">
            <div id="progress-bar"></div>
        </div>
        <p id="status-text">0 / 47 ファイル (0%)</p>
    </div>

    <!-- ここに地図が表示される -->
    <div id="map"></div>

    <!-- 情報表示用パネル -->
    <div id="info-panel" class="hidden">
        <button id="close-btn">&times;</button>
        <h2 id="info-title"></h2>
        <div id="info-details"></div>
    </div>

    <script>
        // 1. 地図の初期化
        const map = L.map('map').setView([35.09, 136.1], 13); // 初期位置を仮設定

        // 2. 背景地図の追加
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // --- UI要素を取得 ---
        const infoPanel = document.getElementById('info-panel');
        const infoTitle = document.getElementById('info-title');
        const infoDetails = document.getElementById('info-details');
        const closeBtn = document.getElementById('close-btn');
        const loader = document.getElementById('loader');
        const progressBar = document.getElementById('progress-bar');
        const statusText = document.getElementById('status-text');
        let selectedLayer = null;
        let geoJsonLayer;

        // --- パネルの閉じるボタンの処理 ---
        closeBtn.addEventListener('click', () => {
            infoPanel.classList.add('hidden');
            if (selectedLayer) {
                geoJsonLayer.resetStyle(selectedLayer);
                selectedLayer = null;
            }
        });

        // 3. 複数のGeoJSONファイルを読み込む
        const promises = [];
        const totalFiles = 47;
        let loadedFiles = 0;

        // プログレスバーを更新する関数
        function updateProgress() {
            loadedFiles++;
            const percentage = Math.round((loadedFiles / totalFiles) * 100);
            progressBar.style.width = percentage + '%';
            statusText.textContent = `${loadedFiles} / ${totalFiles} ファイル (${percentage}%)`;
        }
        
        for (let i = 1; i <= totalFiles; i++) {
            const filename = `A27-23_${i}.geojson`;
            promises.push(
                fetch(filename)
                .then(response => {
                    if (!response.ok) {
                        console.warn(`ファイルが見つかりません: ${filename}`);
                        return null; // ファイルが存在しない場合はnullを返す
                    }
                    return response.json();
                })
                .catch(err => {
                    console.error(`読み込みエラー: ${filename}`, err);
                    return null; // エラーの場合もnullを返す
                })
                .finally(() => {
                    // 成功・失敗にかかわらずプログレスを更新
                    updateProgress();
                })
            );
        }

        // 全てのファイル読み込みが完了するのを待つ
        Promise.all(promises)
            .then(allData => {
                const validData = allData.filter(data => data !== null);
                const allFeatures = validData.reduce((acc, geoJson) => {
                    if (geoJson) {
                        if (geoJson.type === 'FeatureCollection') {
                            return acc.concat(geoJson.features);
                        } else if (geoJson.type === 'Feature') {
                            acc.push(geoJson);
                            return acc;
                        }
                    }
                    return acc;
                }, []);
                
                if (allFeatures.length === 0) {
                    throw new Error('有効なGeoJSONデータが一つも読み込めませんでした。');
                }

                const combinedData = {
                    "type": "FeatureCollection",
                    "features": allFeatures
                };

                geoJsonLayer = L.geoJSON(combinedData, {
                    style: function(feature) {
                        return { color: '#3388ff', weight: 2, opacity: 1, fillOpacity: 0.5 };
                    },
                    onEachFeature: function (feature, layer) {
                        const properties = feature.properties;
                        if (feature.geometry.type.includes('Polygon') && properties) {
                            layer.on('click', function (e) {
                                if (selectedLayer) {
                                    geoJsonLayer.resetStyle(selectedLayer);
                                }
                                infoTitle.textContent = properties.A27_004 || '名称未設定';
                                let detailsHtml = `<p><strong>住所:</strong> ${properties.A27_005 || '情報なし'}</p>`
                                                + `<p><strong>種別:</strong> ${properties.A27_002 || '情報なし'}</p>`
                                                + `<p><strong>ID:</strong> ${properties.A27_001 || '情報なし'}</p>`;
                                infoDetails.innerHTML = detailsHtml;
                                infoPanel.classList.remove('hidden');
                                layer.setStyle({ weight: 4, color: '#ff7800' });
                                layer.bringToFront();
                                selectedLayer = layer;
                            });
                        }
                    }
                }).addTo(map);

                map.fitBounds(geoJsonLayer.getBounds());
            })
            .catch(error => {
                console.error('GeoJSONの読み込みに失敗しました:', error);
                const errorDiv = document.createElement('div');
                errorDiv.innerHTML = 'GeoJSONファイルの読み込みに失敗しました。<br>ファイル名やコンソールを確認してください。';
                errorDiv.style.position = 'absolute';
                errorDiv.style.top = '10px';
                errorDiv.style.left = '50px';
                errorDiv.style.zIndex = 1000;
                errorDiv.style.backgroundColor = 'white';
                errorDiv.style.padding = '10px';
                errorDiv.style.border = '2px solid red';
                document.body.appendChild(errorDiv);
            })
            .finally(() => {
                // 成功・失敗にかかわらずローディング画面を非表示にする
                loader.style.display = 'none';
            });
    </script>
</body>
</html>

